# Using a modern, stable version of the Compose file format.
version: "3.9"

services:
    # The Master Node is the central coordinator of the system[cite: 92].
    master:
        build:
            context: ./master
            dockerfile: Dockerfile.master
        ports:
            - "50050:50050"
        networks:
            - query_network

    # Worker Node 1 executes tasks on its local database instance[cite: 102].
    worker1:
        build:
            context: ./worker
            dockerfile: Dockerfile.worker
        ports:
            - "50051:50051"
        environment:
            - DATABASE_HOST=db1
        depends_on:
            - db1
        networks:
            - query_network

    # Worker Node 2, identical to the first but connected to a different database.
    worker2:
        build:
            context: ./worker
            dockerfile: Dockerfile.worker
        ports:
            - "50052:50051"
        environment:
            - DATABASE_HOST=db2
        depends_on:
            - db2
        networks:
            - query_network

    # Database for Worker 1. Using the official PostgreSQL 16 image[cite: 85, 156].
    db1:
        image: postgres:16
        environment:
            POSTGRES_USER: user
            POSTGRES_PASSWORD: password
            POSTGRES_DB: distributed_db
        # This volume runs the init script to create the schema on first startup.
        volumes:
            - ./db/init-db1.sql:/docker-entrypoint-initdb.d/init.sql
        ports:
            - "54321:5432"
        networks:
            - query_network

    # Database for Worker 2.
    db2:
        image: postgres:16
        environment:
            POSTGRES_USER: user
            POSTGRES_PASSWORD: password
            POSTGRES_DB: distributed_db
        volumes:
            - ./db/init-db2.sql:/docker-entrypoint-initdb.d/init.sql
        ports:
            - "54322:5432"
        networks:
            - query_network

# Defines the shared network for all services to communicate[cite: 105].
networks:
    query_network:
        driver: bridge
